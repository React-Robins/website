{"version":3,"sources":["../../../src/internal-plugins/query-runner/pages-writer.js"],"names":["_","require","fs","crypto","store","emitter","lastHash","writePages","bootstrapFinished","getState","program","jsonDataPaths","pages","values","pagesComponentDependencies","pagesData","forEach","path","matchPath","componentChunkName","jsonName","pageComponentsChunkNames","push","sortBy","p","value","newHash","createHash","update","JSON","stringify","digest","Promise","resolve","components","component","uniqBy","c","syncRequires","map","join","asyncRequires","directory","writeAndMove","file","data","destination","tmp","Date","now","writeFile","then","move","overwrite","result","all","dataPaths","toPairs","fromPairs","exports","resetLastHash","oldPages","debouncedWritePages","debounce","isEqual","leading","on"],"mappings":"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","sourcesContent":["const _ = require(`lodash`)\nconst fs = require(`fs-extra`)\nconst crypto = require(`crypto`)\n\nconst { store, emitter } = require(`../../redux/`)\n\nimport { joinPath } from \"../../utils/path\"\n\nlet lastHash = null\n\n// Write out pages information.\nconst writePages = async () => {\n  bootstrapFinished = true\n  let { program, jsonDataPaths, pages } = store.getState()\n  pages = [...pages.values()]\n\n  const pagesComponentDependencies = {}\n\n  // Write out pages.json\n  let pagesData = []\n  pages.forEach(({ path, matchPath, componentChunkName, jsonName }) => {\n    const pageComponentsChunkNames = {\n      componentChunkName,\n    }\n\n    if (program._[0] === `develop`) {\n      pagesComponentDependencies[path] = pageComponentsChunkNames\n    }\n\n    pagesData.push({\n      ...pageComponentsChunkNames,\n      jsonName,\n      path,\n      matchPath,\n    })\n  })\n\n  pagesData = _(pagesData)\n    // Ensure pages keep the same sorting through builds\n    // and sort pages with matchPath to end so explicit routes\n    // will match before general.\n    .sortBy(p => `${p.matchPath ? 1 : 0}${p.path}`)\n    .value()\n  const newHash = crypto\n    .createHash(`md5`)\n    .update(JSON.stringify(pagesComponentDependencies))\n    .digest(`hex`)\n\n  if (newHash === lastHash) {\n    // components didn't change - no need to rewrite pages.json\n    return Promise.resolve()\n  }\n\n  lastHash = newHash\n\n  // Get list of components, and json files.\n  let components = []\n  pages.forEach(p => {\n    components.push({\n      componentChunkName: p.componentChunkName,\n      component: p.component,\n    })\n  })\n\n  components = _.uniqBy(components, c => c.componentChunkName)\n\n  // Create file with sync requires of components/json files.\n  let syncRequires = `// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n\\n`\n  syncRequires += `exports.components = {\\n${components\n    .map(\n      c =>\n        `  \"${c.componentChunkName}\": preferDefault(require(\"${joinPath(\n          c.component\n        )}\"))`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n\n  // Create file with async requires of components/json files.\n  let asyncRequires = `// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n`\n  asyncRequires += `exports.components = {\\n${components\n    .map(\n      c =>\n        `  \"${c.componentChunkName}\": () => import(\"${joinPath(\n          c.component\n        )}\" /* webpackChunkName: \"${c.componentChunkName}\" */)`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n\n  asyncRequires += `exports.data = () => import(\"${joinPath(\n    program.directory,\n    `.cache`,\n    `data.json`\n  )}\")\\n\\n`\n\n  const writeAndMove = (file, data) => {\n    const destination = joinPath(program.directory, `.cache`, file)\n    const tmp = `${destination}.${Date.now()}`\n    return fs\n      .writeFile(tmp, data)\n      .then(() => fs.move(tmp, destination, { overwrite: true }))\n  }\n\n  const result = await Promise.all([\n    writeAndMove(`pages.json`, JSON.stringify(pagesData, null, 4)),\n    writeAndMove(`sync-requires.js`, syncRequires),\n    writeAndMove(`async-requires.js`, asyncRequires),\n    writeAndMove(\n      `data.json`,\n      JSON.stringify({\n        pages: pagesData,\n        // Sort dataPaths by keys to ensure keeping the same\n        // sorting through builds\n        dataPaths: _(jsonDataPaths)\n          .toPairs()\n          .sortBy(0)\n          .fromPairs()\n          .value(),\n      })\n    ),\n  ])\n\n  return result\n}\n\nexports.writePages = writePages\n\nconst resetLastHash = () => {\n  lastHash = null\n}\n\nexports.resetLastHash = resetLastHash\n\nlet bootstrapFinished = false\nlet oldPages\nconst debouncedWritePages = _.debounce(\n  () => {\n    // Don't write pages again until bootstrap has finished.\n    if (bootstrapFinished && !_.isEqual(oldPages, store.getState().pages)) {\n      writePages()\n      oldPages = store.getState().pages\n    }\n  },\n  500,\n  { leading: true }\n)\nemitter.on(`CREATE_PAGE`, () => {\n  // Ignore CREATE_PAGE until bootstrap is finished\n  // as this is called many many times during bootstrap and\n  // we can ignore them until CREATE_PAGE_END is called.\n  //\n  // After bootstrap, we need to listen for this as stateful page\n  // creators e.g. the plugin \"gatsby-plugin-page-creator\"\n  // calls createPage directly so CREATE_PAGE_END won't get fired.\n  if (bootstrapFinished) {\n    debouncedWritePages()\n  }\n})\n\nemitter.on(`CREATE_PAGE_END`, () => {\n  debouncedWritePages()\n})\nemitter.on(`DELETE_PAGE`, () => {\n  debouncedWritePages()\n})\nemitter.on(`DELETE_PAGE_BY_PATH`, () => {\n  debouncedWritePages()\n})\n"],"file":"pages-writer.js"}